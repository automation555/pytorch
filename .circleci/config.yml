# WARNING: DO NOT EDIT THIS FILE DIRECTLY!!!
# See the README.md in this directory.

# IMPORTANT: To update Docker image version, please follow
# the instructions at
# https://github.com/pytorch/pytorch/wiki/Docker-image-build-on-CircleCI

version: 2.1

executors:
  windows-with-nvidia-gpu:
    machine:
      resource_class: windows.gpu.nvidia.medium
      image: windows-server-2019-nvidia:stable
      shell: cmd.exe

  windows-xlarge-cpu-with-nvidia-cuda:
    machine:
      resource_class: windows.xlarge
      image: windows-server-2019-vs2019:stable
      shell: cmd.exe

magma_params: &magma_params
  parameters:
    configuration:
      type: string
      default: ""
    cuda_version:
      type: string
      default: ""
  environment:
    CONFIG: << parameters.configuration >>
    CUVER_NODOT: << parameters.cuda_version >>
    CUDA_VERSION: << parameters.cuda_version >>

jobs:
  magma-build:
    <<: *magma_params
    executor: windows-xlarge-cpu-with-nvidia-cuda
    steps:
      - checkout
      - run:
          name: "Build"
          command: |
            call build.bat
            if errorlevel 1 exit /b 1
      - store_artifacts:
          path: magma_build

workflows:
  build:
    jobs:
      # - magma-build:
      #     name: magma-build-cu101-debug
      #     cuda_version: "101"
      #     configuration: "Debug"
      # - magma-build:
      #     name: magma-build-cu101-release
      #     cuda_version: "101"
      #     configuration: "Release"
      # - magma-build:
      #     name: magma-build-cu102-debug
      #     cuda_version: "102"
      #     configuration: "Debug"
      # - magma-build:
      #     name: magma-build-cu102-release
      #     cuda_version: "102"
      #     configuration: "Release"
      # - magma-build:
      #     name: magma-build-cu110-debug
      #     cuda_version: "110"
      #     configuration: "Debug"
      # - magma-build:
      #     name: magma-build-cu110-release
      #     cuda_version: "110"
      #     configuration: "Release"
      # - magma-build:
      #     name: magma-build-cu111-debug
      #     cuda_version: "111"
      #     configuration: "Debug"
      # - magma-build:
      #     name: magma-build-cu111-release
      #     cuda_version: "111"
      #     configuration: "Release"
      - magma-build:
          name: magma-build-cu112-debug
          cuda_version: "112"
          configuration: "Debug"
      - magma-build:
          name: magma-build-cu112-release
          cuda_version: "112"
          configuration: "Release"
