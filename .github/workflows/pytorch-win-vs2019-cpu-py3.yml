# WARNING THIS IS AUTOGENERATED DO NOT UPDATE MANUALLY PLS
# Template is at:    .github/templates/windows_ci_workflow.yml
# Generation script: .github/scripts/generate_windows_ci_workflows.py
name: Windows CI (pytorch-win-vs2019-cpu-py3)

on:
  pull_request:
  push:
    branches:
      - master
      - release/*
  workflow_dispatch:

env:
  BUILD_ENVIRONMENT: pytorch-win-vs2019-cpu-py3
  CUDA_VERSION: cpu
  USE_CUDA: 0
  SCCACHE_BUCKET: ossci-compiler-cache-circleci-v2
  IN_CI: 1

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: windows-2019
    steps:
      - name: Checkout PyTorch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Build
        run: .jenkins/pytorch/win-build.sh
      - name: Store PyTorch Build Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_ENVIRONMENT }}
          path: build-results
  test:
    runs-on: windows-2019
    needs:
      - build
    steps:
      - name: Checkout PyTorch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: recursive
      - name: Download PyTorch Build Artifacts
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.BUILD_ENVIRONMENT }}
      - name: Test
        run: .jenkins/pytorch/win-test.sh
      - name: Report test results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()
        with:
          comment_on_pr: false
          pull_request_build: commit
          files: test/test-reports/**/*.xml
